name: Daily EGPS Scraper

permissions:
  contents: write

on:
  schedule:
    - cron: "20 3 * * *"   # 每天 02:00 UTC = 台北時間 10:00
  workflow_dispatch: {}    # 可手動觸發

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 取出專案程式碼
      - uses: actions/checkout@v4

      # 2️⃣ 設定 Python 環境
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️⃣ 安裝套件
      - name: Install dependencies
        run: python -m pip install -r EGPS_Web_Scraper_daily/requirements.txt

      # 4️⃣ 建立 Google Service Account 憑證檔案（安全寫入）
      - name: Write service account json
        shell: bash
        run: |
          mkdir -p service_account
          cat > service_account/kiehls-scraper.json <<EOF
          ${{ secrets.GCP_SA_JSON }}
          EOF

      # 5️⃣ 執行爬蟲程式
      - name: Run scraper
        env:
          TZ: Asia/Taipei
        run: |
          python EGPS_Web_Scraper_daily/egps_to_gsheet_rolex_daily.py > result.log 2>&1
          tail -n 30 result.log

      # 6️⃣ 產生日期變數（要放在寄信步驟上方）
      - name: Set date variables
        id: date
        run: |
          echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "full=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        env:
          TZ: Asia/Taipei

      # 7️⃣ 寄送每日執行結果報告
      - name: Send daily report email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "【EGPS 每日報告】 ${{ steps.date.outputs.today }} Rolex 爬蟲執行結果"
          to: ${{ secrets.MAIL_TO }}
          from: "EGPS Watch Scraper <${{ secrets.MAIL_USERNAME }}>"
          body: |
            ✅ EGPS Rolex 爬蟲執行完成

            📅 日期：${{ steps.date.outputs.full }}
            📊 來源：EGPS 永生名錶網站
            📈 結果摘要：
              - 詳細紀錄請見附件（GitHub Logs）
              - 資料已更新至 Google Sheet

            🔗 Google Sheet 連結：
            https://docs.google.com/spreadsheets/d/1LjyB8BfL6MrEdATkj_3cuhdJcF_CAxiQbGnGtzhJtCY

            👋 本郵件由 GitHub Actions 自動發送
