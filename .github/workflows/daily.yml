name: Daily EGPS Scraper

on:
  schedule:
    - cron: "0 2 * * *"   # æ¯å¤© 02:00 UTC = å°åŒ—æ™‚é–“ 10:00
  workflow_dispatch: {}    # å¯æ‰‹å‹•è§¸ç™¼

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ å–å‡ºå°ˆæ¡ˆç¨‹å¼ç¢¼
      - uses: actions/checkout@v4

      # 2ï¸âƒ£ è¨­å®š Python ç’°å¢ƒ
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3ï¸âƒ£ å®‰è£å¥—ä»¶
      - name: Install dependencies
        run: python -m pip install -r EGPS_Web_Scraper_daily/requirements.txt

      # 4ï¸âƒ£ å»ºç«‹ Google Service Account æ†‘è­‰æª”æ¡ˆï¼ˆå®‰å…¨å¯«å…¥ï¼‰
      - name: Write service account json
        shell: bash
        run: |
          mkdir -p service_account
          cat > service_account/kiehls-scraper.json <<EOF
          ${{ secrets.GCP_SA_JSON }}
          EOF

      # 5ï¸âƒ£ åŸ·è¡Œçˆ¬èŸ²ç¨‹å¼
      - name: Run scraper
        env:
          TZ: Asia/Taipei
        run: |
          python EGPS_Web_Scraper_daily/egps_to_gsheet_rolex_daily.py > result.log 2>&1
          tail -n 30 result.log

      # 6ï¸âƒ£ å¯„é€æ¯æ—¥åŸ·è¡Œçµæœå ±å‘Š
      - name: Send daily report email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ã€EGPS æ¯æ—¥å ±å‘Šã€‘$(date +'%Y-%m-%d') Rolex çˆ¬èŸ²åŸ·è¡Œçµæœ"
          to: ${{ secrets.MAIL_TO }}
          from: "EGPS Watch Scraper <${{ secrets.MAIL_USERNAME }}>"
          body: |
            âœ… EGPS Rolex çˆ¬èŸ²åŸ·è¡Œå®Œæˆ

            ğŸ“… æ—¥æœŸï¼š$(date +'%Y-%m-%d %H:%M:%S' --date='TZ="Asia/Taipei" now')
            ğŸ“Š ä¾†æºï¼šEGPS æ°¸ç”ŸåéŒ¶ç¶²ç«™
            ğŸ“ˆ çµæœæ‘˜è¦ï¼š
              - è©³ç´°ç´€éŒ„è«‹è¦‹é™„ä»¶ï¼ˆGitHub Logsï¼‰
              - è³‡æ–™å·²æ›´æ–°è‡³ Google Sheet

            ğŸ”— Google Sheet é€£çµï¼š
            https://docs.google.com/spreadsheets/d/1LjyB8BfL6MrEdATkj_3cuhdJcF_CAxiQbGnGtzhJtCY

            ğŸ‘‹ æœ¬éƒµä»¶ç”± GitHub Actions è‡ªå‹•ç™¼é€
